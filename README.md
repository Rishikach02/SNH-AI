# Tree API Server

A production-ready HTTP API for managing hierarchical tree structures, built entirely with Python's standard library and SQLite for persistence.

## Table of Contents

- [Overview](#overview)
- [Architecture & Design](#architecture--design)
- [Project Structure](#project-structure)
- [How It Works](#how-it-works)
- [Features](#features)
- [Requirements](#requirements)
- [Installation & Setup](#installation--setup)
- [Running the Server](#running-the-server)
- [API Documentation](#api-documentation)
- [Testing](#testing)
- [Design Decisions](#design-decisions)
- [Further Improvements](#further-improvements)

## Overview

This project implements a RESTful API for creating and managing tree data structures. It supports:
- Creating root nodes
- Attaching child nodes to existing parents
- Retrieving the entire forest (multiple trees) as nested JSON
- Persistent storage using SQLite
- Proper error handling and HTTP status codes

**Key Highlight**: Built using only Python's standard library - no external dependencies required!

## Architecture & Design

### High-Level Architecture

The application follows a **layered architecture** pattern with clear separation of concerns:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLIENT (curl, browser, app)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ HTTP Request
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HTTP LAYER (server.py)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ThreadingHTTPServer + TreeRequestHandler               â”‚    â”‚
â”‚  â”‚  â€¢ Route requests (GET/POST /api/tree)                  â”‚    â”‚
â”‚  â”‚  â€¢ Parse/serialize JSON                                 â”‚    â”‚
â”‚  â”‚  â€¢ HTTP status codes & error handling                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ Function Call
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                SERVICE LAYER (tree_service.py)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Business Logic & Validation                            â”‚    â”‚
â”‚  â”‚  â€¢ create_node(label, parent_id)                        â”‚    â”‚
â”‚  â”‚  â€¢ list_trees() â†’ builds forest structure               â”‚    â”‚
â”‚  â”‚  â€¢ Input validation (empty labels, etc.)                â”‚    â”‚
â”‚  â”‚  â€¢ Custom exceptions (ValidationError, NodeNotFound)    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ SQL Queries
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATA LAYER (db.py)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Database Operations                                    â”‚    â”‚
â”‚  â”‚  â€¢ initialize() â†’ creates schema                        â”‚    â”‚
â”‚  â”‚  â€¢ get_connection() â†’ context manager                   â”‚    â”‚
â”‚  â”‚  â€¢ Connection pooling & cleanup                         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ Read/Write
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PERSISTENCE LAYER                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  SQLite Database (data/trees.db)                        â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚    â”‚
â”‚  â”‚  â”‚  nodes table                                â”‚        â”‚    â”‚
â”‚  â”‚  â”‚  â€¢ id (PK, AUTOINCREMENT)                   â”‚        â”‚    â”‚
â”‚  â”‚  â”‚  â€¢ label (TEXT, NOT NULL)                   â”‚        â”‚    â”‚
â”‚  â”‚  â”‚  â€¢ parent_id (FK â†’ nodes.id, nullable)      â”‚        â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   config.py           â”‚
                    â”‚  â€¢ Environment vars   â”‚
                    â”‚  â€¢ DB_PATH, HOST, PORTâ”‚
                    â”‚  â€¢ Path resolution    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â””â”€â”€â”€â–º Used by all layers
```

### Component Interaction Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. HTTP Request
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TreeRequestHandler                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  2. do_GET() or do_POST()                          â”‚     â”‚
â”‚  â”‚     â”‚                                               â”‚     â”‚
â”‚  â”‚     â”œâ”€â–º handle_list_trees()                        â”‚     â”‚
â”‚  â”‚     â”‚   â”‚                                           â”‚     â”‚
â”‚  â”‚     â”‚   â””â”€â–º tree_service.list_trees()              â”‚     â”‚
â”‚  â”‚     â”‚       â”‚                                       â”‚     â”‚
â”‚  â”‚     â”‚       â”œâ”€â–º db.get_connection()                â”‚     â”‚
â”‚  â”‚     â”‚       â”œâ”€â–º SELECT * FROM nodes                â”‚     â”‚
â”‚  â”‚     â”‚       â””â”€â–º _rows_to_forest()                  â”‚     â”‚
â”‚  â”‚     â”‚           (Build tree hierarchy)             â”‚     â”‚
â”‚  â”‚     â”‚                                               â”‚     â”‚
â”‚  â”‚     â””â”€â–º handle_create_node()                       â”‚     â”‚
â”‚  â”‚         â”‚                                           â”‚     â”‚
â”‚  â”‚         â”œâ”€â–º _read_json_body()                      â”‚     â”‚
â”‚  â”‚         â”œâ”€â–º validate payload                       â”‚     â”‚
â”‚  â”‚         â””â”€â–º tree_service.create_node()             â”‚     â”‚
â”‚  â”‚             â”‚                                       â”‚     â”‚
â”‚  â”‚             â”œâ”€â–º Validate label                     â”‚     â”‚
â”‚  â”‚             â”œâ”€â–º Check parent exists (if needed)    â”‚     â”‚
â”‚  â”‚             â”œâ”€â–º db.get_connection()                â”‚     â”‚
â”‚  â”‚             â”œâ”€â–º INSERT INTO nodes                  â”‚     â”‚
â”‚  â”‚             â””â”€â–º Return TreeNode                    â”‚     â”‚
â”‚  â”‚                                                     â”‚     â”‚
â”‚  â”‚  3. _send_json() or _send_error_json()            â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. HTTP Response (JSON)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Layer Responsibilities

1. **HTTP Layer** (`server.py`):
   - Handles HTTP requests and responses
   - Routes requests to appropriate handlers
   - Serializes/deserializes JSON
   - Manages HTTP status codes
   - Error response formatting

2. **Service Layer** (`tree_service.py`):
   - Contains business logic
   - Performs input validation
   - Builds tree structures from flat data
   - Handles domain-specific errors
   - Data transformation (rows â†’ TreeNode objects)

3. **Data Layer** (`db.py`):
   - Manages database connections
   - Initializes database schema
   - Provides connection context managers
   - Ensures proper resource cleanup

4. **Configuration** (`config.py`):
   - Centralizes all configuration
   - Handles environment variables
   - Computes paths and defaults
   - No hardcoded values

## Project Structure

```
assesment/
â”œâ”€â”€ data/
â”‚   â””â”€â”€ trees.db              # SQLite database (created on first run)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py           # Package marker
â”‚   â”œâ”€â”€ config.py             # Configuration and environment variables
â”‚   â”œâ”€â”€ db.py                 # Database initialization and connection management
â”‚   â”œâ”€â”€ server.py             # HTTP server and request handlers
â”‚   â””â”€â”€ tree_service.py       # Business logic for tree operations
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ __init__.py           # Test package marker
â”‚   â”œâ”€â”€ test_server.py        # HTTP API integration tests
â”‚   â””â”€â”€ test_tree_service.py  # Service layer unit tests
â”œâ”€â”€ requirements.txt          # Python dependencies (empty - stdlib only!)
â””â”€â”€ README.md                 # This file
```

## How It Works

### 1. Server Initialization

When you run `python -m src.server`:

1. **Configuration is loaded** from `config.py`:
   - Reads environment variables or uses defaults
   - Sets up database path, host, and port

2. **Database is initialized** via `db.initialize()`:
   - Creates `data/` directory if missing
   - Creates `nodes` table if it doesn't exist
   - Schema: `id`, `label`, `parent_id` (self-referencing foreign key)

3. **HTTP server starts** on the configured host and port:
   - Uses Python's `ThreadingHTTPServer` for concurrent request handling
   - Registers `TreeRequestHandler` for request processing

### 2. Request Flow Diagrams

#### Creating a Node (POST /api/tree)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â”‚  POST /api/tree
     â”‚  Content-Type: application/json
     â”‚  Body: {"label": "child", "parent_id": 1}
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  server.py :: TreeRequestHandler                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. do_POST()                                          â”‚
â”‚     â””â”€â–º Check path == "/api/tree"                     â”‚
â”‚         â””â”€â–º Call handle_create_node()                 â”‚
â”‚                                                        â”‚
â”‚  2. handle_create_node()                              â”‚
â”‚     â”œâ”€â–º Read Content-Length header                    â”‚
â”‚     â”œâ”€â–º Read request body                             â”‚
â”‚     â”œâ”€â–º Parse JSON: json.loads()                      â”‚
â”‚     â”‚   â””â”€â–º Extract: label, parent_id                 â”‚
â”‚     â”‚                                                  â”‚
â”‚     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€ Validation â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚     â”‚   â”‚ parent_id not None?     â”‚                   â”‚
â”‚     â”‚   â”‚   â†’ Convert to int      â”‚                   â”‚
â”‚     â”‚   â”‚   â†’ If fails: 400 error â”‚                   â”‚
â”‚     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚     â”‚                                                  â”‚
â”‚     â””â”€â–º Call tree_service.create_node(label, parent_id)
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  tree_service.py                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  3. create_node(label, parent_id)                     â”‚
â”‚     â”‚                                                  â”‚
â”‚     â”œâ”€â–º Validate label                                â”‚
â”‚     â”‚   label = (label or "").strip()                 â”‚
â”‚     â”‚   â””â”€â–º if not label:                             â”‚
â”‚     â”‚       raise ValidationError("label is required")â”‚
â”‚     â”‚                                                  â”‚
â”‚     â”œâ”€â–º Get database connection                       â”‚
â”‚     â”‚   with db.get_connection() as conn:             â”‚
â”‚     â”‚                                                  â”‚
â”‚     â”œâ”€â–º If parent_id provided:                        â”‚
â”‚     â”‚   â”‚   SELECT id FROM nodes WHERE id = ?         â”‚
â”‚     â”‚   â”‚   â””â”€â–º If not found:                         â”‚
â”‚     â”‚   â”‚       raise NodeNotFound(...)               â”‚
â”‚     â”‚                                                  â”‚
â”‚     â”œâ”€â–º Insert into database                          â”‚
â”‚     â”‚   INSERT INTO nodes (label, parent_id)          â”‚
â”‚     â”‚   VALUES (?, ?)                                 â”‚
â”‚     â”‚   â””â”€â–º Get lastrowid â†’ node_id                   â”‚
â”‚     â”‚                                                  â”‚
â”‚     â”œâ”€â–º Commit transaction                            â”‚
â”‚     â”‚   conn.commit()                                 â”‚
â”‚     â”‚                                                  â”‚
â”‚     â””â”€â–º Return TreeNode(id, label, parent_id)         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  db.py                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  4. SQLite Operations                                 â”‚
â”‚     â”œâ”€â–º Open connection to data/trees.db              â”‚
â”‚     â”œâ”€â–º Execute SQL queries                           â”‚
â”‚     â”œâ”€â–º Return results                                â”‚
â”‚     â””â”€â–º Close connection (context manager)            â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  server.py :: TreeRequestHandler (continued)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  5. Response Handling                                 â”‚
â”‚     â”‚                                                  â”‚
â”‚     â”œâ”€â–º Success Path:                                 â”‚
â”‚     â”‚   â”œâ”€â–º node.to_dict() â†’ {"id": 2, "label":...}  â”‚
â”‚     â”‚   â”œâ”€â–º json.dumps() â†’ serialize                  â”‚
â”‚     â”‚   â”œâ”€â–º Set status: 201 CREATED                   â”‚
â”‚     â”‚   â”œâ”€â–º Set header: Content-Type: application/jsonâ”‚
â”‚     â”‚   â””â”€â–º Write response body                       â”‚
â”‚     â”‚                                                  â”‚
â”‚     â””â”€â–º Error Paths:                                  â”‚
â”‚         â”œâ”€â–º ValidationError â†’ 400 BAD REQUEST         â”‚
â”‚         â”œâ”€â–º NodeNotFound â†’ 404 NOT FOUND              â”‚
â”‚         â””â”€â–º Exception â†’ 500 INTERNAL SERVER ERROR     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚  HTTP/1.1 201 Created
     â”‚  Content-Type: application/json
     â”‚  Body: {"id": 2, "label": "child", "children": []}
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Retrieving Trees (GET /api/tree)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â”‚  GET /api/tree
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  server.py :: TreeRequestHandler                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. do_GET()                                          â”‚
â”‚     â””â”€â–º Check path == "/api/tree"                     â”‚
â”‚         â””â”€â–º Call handle_list_trees()                  â”‚
â”‚                                                        â”‚
â”‚  2. handle_list_trees()                               â”‚
â”‚     â””â”€â–º Call tree_service.list_trees()                â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  tree_service.py                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  3. list_trees()                                      â”‚
â”‚     â”‚                                                  â”‚
â”‚     â”œâ”€â–º Get database connection                       â”‚
â”‚     â”‚   with db.get_connection() as conn:             â”‚
â”‚     â”‚                                                  â”‚
â”‚     â”œâ”€â–º Query all nodes                               â”‚
â”‚     â”‚   SELECT id, label, parent_id                   â”‚
â”‚     â”‚   FROM nodes                                    â”‚
â”‚     â”‚   ORDER BY id                                   â”‚
â”‚     â”‚   â””â”€â–º Returns: [Row(1,'root',None),            â”‚
â”‚     â”‚                 Row(2,'child',1), ...]          â”‚
â”‚     â”‚                                                  â”‚
â”‚     â””â”€â–º Call _rows_to_forest(rows)                    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  tree_service.py :: _rows_to_forest()                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  4. Build Tree Hierarchy                              â”‚
â”‚     â”‚                                                  â”‚
â”‚     â”œâ”€â–º Phase 1: Create node objects                  â”‚
â”‚     â”‚   nodes = {}                                    â”‚
â”‚     â”‚   for row in rows:                              â”‚
â”‚     â”‚     nodes[row.id] = TreeNode(                   â”‚
â”‚     â”‚       id=row.id,                                â”‚
â”‚     â”‚       label=row.label,                          â”‚
â”‚     â”‚       parent_id=row.parent_id                   â”‚
â”‚     â”‚     )                                            â”‚
â”‚     â”‚   Result: {1: TreeNode(...), 2: TreeNode(...)} â”‚
â”‚     â”‚                                                  â”‚
â”‚     â”œâ”€â–º Phase 2: Link children to parents             â”‚
â”‚     â”‚   roots = []                                    â”‚
â”‚     â”‚   for node in nodes.values():                   â”‚
â”‚     â”‚     if node.parent_id is None:                  â”‚
â”‚     â”‚       roots.append(node)  # Root node          â”‚
â”‚     â”‚     else:                                       â”‚
â”‚     â”‚       parent = nodes.get(node.parent_id)        â”‚
â”‚     â”‚       if parent:                                â”‚
â”‚     â”‚         parent.children.append(node)            â”‚
â”‚     â”‚       else:                                     â”‚
â”‚     â”‚         roots.append(node)  # Orphaned node    â”‚
â”‚     â”‚                                                  â”‚
â”‚     â”œâ”€â–º Phase 3: Sort for deterministic output        â”‚
â”‚     â”‚   roots.sort(key=lambda n: n.id)               â”‚
â”‚     â”‚   for each root:                                â”‚
â”‚     â”‚     sort_children(root)  # Recursive sort      â”‚
â”‚     â”‚                                                  â”‚
â”‚     â””â”€â–º Return [root1, root2, ...]                    â”‚
â”‚                                                        â”‚
â”‚   Example Result:                                     â”‚
â”‚   [TreeNode(id=1, label='root', children=[           â”‚
â”‚      TreeNode(id=2, label='child', children=[])       â”‚
â”‚   ])]                                                 â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  server.py :: TreeRequestHandler (continued)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  5. Serialize Response                                â”‚
â”‚     â”‚                                                  â”‚
â”‚     â”œâ”€â–º trees = [node.to_dict() for node in ...]     â”‚
â”‚     â”‚   â”‚                                              â”‚
â”‚     â”‚   â””â”€â–º Recursive serialization via TreeNode.to_dict()
â”‚     â”‚       def to_dict():                            â”‚
â”‚     â”‚         return {                                â”‚
â”‚     â”‚           "id": self.id,                        â”‚
â”‚     â”‚           "label": self.label,                  â”‚
â”‚     â”‚           "children": [                         â”‚
â”‚     â”‚             child.to_dict() for child in ...    â”‚
â”‚     â”‚           ]                                     â”‚
â”‚     â”‚         }                                       â”‚
â”‚     â”‚                                                  â”‚
â”‚     â”œâ”€â–º json.dumps(trees)                             â”‚
â”‚     â”œâ”€â–º Set status: 200 OK                            â”‚
â”‚     â”œâ”€â–º Set header: Content-Type: application/json    â”‚
â”‚     â””â”€â–º Write response body                           â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚  HTTP/1.1 200 OK
     â”‚  Content-Type: application/json
     â”‚  Body: [{"id":1,"label":"root","children":[...]}]
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Data Transformation Flow

This diagram shows how data is transformed at each layer:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLIENT REQUEST                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Raw HTTP Request:                                              â”‚
â”‚  POST /api/tree HTTP/1.1                                        â”‚
â”‚  Content-Type: application/json                                 â”‚
â”‚  Content-Length: 35                                             â”‚
â”‚                                                                 â”‚
â”‚  {"label": "child", "parent_id": 1}                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HTTP LAYER                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Python dict:                                                   â”‚
â”‚  {                                                              â”‚
â”‚    "label": "child",                                            â”‚
â”‚    "parent_id": 1                                               â”‚
â”‚  }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SERVICE LAYER                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Function parameters:                                           â”‚
â”‚  label: str = "child"                                           â”‚
â”‚  parent_id: int | None = 1                                      â”‚
â”‚                                                                 â”‚
â”‚  After validation:                                              â”‚
â”‚  label: str = "child" (trimmed, non-empty)                      â”‚
â”‚  parent_id: int = 1 (exists in database)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DATA LAYER                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SQL Query:                                                     â”‚
â”‚  INSERT INTO nodes (label, parent_id) VALUES (?, ?)            â”‚
â”‚  Parameters: ("child", 1)                                       â”‚
â”‚                                                                 â”‚
â”‚  Result:                                                        â”‚
â”‚  cursor.lastrowid = 2                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DATABASE                                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Table: nodes                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚ id â”‚ label  â”‚ parent_id â”‚                                   â”‚
â”‚  â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                   â”‚
â”‚  â”‚  1 â”‚ root   â”‚    NULL   â”‚                                   â”‚
â”‚  â”‚  2 â”‚ child  â”‚      1    â”‚  â† NEW ROW                        â”‚
â”‚  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SERVICE LAYER                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  TreeNode object:                                               â”‚
â”‚  TreeNode(                                                      â”‚
â”‚    id=2,                                                        â”‚
â”‚    label="child",                                               â”‚
â”‚    parent_id=1,                                                 â”‚
â”‚    children=[]                                                  â”‚
â”‚  )                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HTTP LAYER                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Python dict (via .to_dict()):                                 â”‚
â”‚  {                                                              â”‚
â”‚    "id": 2,                                                     â”‚
â”‚    "label": "child",                                            â”‚
â”‚    "children": []                                               â”‚
â”‚  }                                                              â”‚
â”‚                                                                 â”‚
â”‚  JSON string (via json.dumps()):                               â”‚
â”‚  '{"id": 2, "label": "child", "children": []}'                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLIENT RESPONSE                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  HTTP/1.1 201 Created                                           â”‚
â”‚  Content-Type: application/json                                 â”‚
â”‚  Content-Length: 42                                             â”‚
â”‚                                                                 â”‚
â”‚  {"id": 2, "label": "child", "children": []}                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. Tree Construction Algorithm

The `_rows_to_forest()` function in `tree_service.py` converts a flat list of database rows into a hierarchical structure:

```python
# Algorithm steps:
1. Create a dictionary: node_id â†’ TreeNode object
2. Iterate through nodes:
   - If parent_id is NULL â†’ add to roots list
   - Otherwise â†’ append to parent's children list
3. Sort roots and recursively sort children by ID
4. Return list of root nodes (each with nested children)
```

**Time Complexity**: **O(n)** where n = number of nodes

**Visual Example**:

```
Database (Flat):                      Memory (Hierarchical):
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id â”‚ label  â”‚ parent_id â”‚           1: root
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”œâ”€â–º 2: child1
â”‚  1 â”‚ root   â”‚   NULL    â”‚           â”‚   â””â”€â–º 4: grandchild
â”‚  2 â”‚ child1 â”‚     1     â”‚   â”€â”€â”€â–º    â””â”€â–º 3: child2
â”‚  3 â”‚ child2 â”‚     1     â”‚
â”‚  4 â”‚ grandchâ”‚     2     â”‚           5: another_root
â”‚  5 â”‚ anotherâ”‚   NULL    â”‚           
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    (Rows in DB)                    (TreeNode objects with .children)

Final JSON Output:
[
  {
    "id": 1,
    "label": "root",
    "children": [
      {
        "id": 2,
        "label": "child1",
        "children": [
          {"id": 4, "label": "grandchild", "children": []}
        ]
      },
      {"id": 3, "label": "child2", "children": []}
    ]
  },
  {
    "id": 5,
    "label": "another_root",
    "children": []
  }
]
```

## Features

- âœ… **RESTful API** with proper HTTP semantics
- âœ… **Persistent storage** - data survives server restarts
- âœ… **Hierarchical trees** - unlimited nesting depth
- âœ… **Multiple trees** - supports a forest of independent trees
- âœ… **Input validation** - proper error messages for invalid input
- âœ… **No external dependencies** - pure Python standard library
- âœ… **Concurrent requests** - ThreadingHTTPServer handles multiple clients
- âœ… **Type hints** - full type annotations for better code quality
- âœ… **Comprehensive tests** - unit and integration tests included
- âœ… **Configurable** - environment variables for all settings

## Requirements

- **Python 3.10+** (uses modern type hints and features)
- No third-party packages required!

## Installation & Setup

1. **Clone or download** the project

2. **(Optional) Create a virtual environment**:
   ```bash
   python -m venv .venv
   source .venv/bin/activate  # On Windows: .venv\Scripts\activate
   ```

3. **No dependencies to install** - the project uses only Python's standard library!

## Running the Server

### Basic Usage

```bash
python -m src.server
```

The server will start on `http://127.0.0.1:8000`

### Custom Configuration

Use environment variables to customize:

```bash
# Run on a different port
TREE_API_PORT=9000 python -m src.server

# Run on all interfaces
TREE_API_HOST=0.0.0.0 TREE_API_PORT=8080 python -m src.server

# Use a different database file
TREE_API_DB_PATH=/tmp/my_trees.db python -m src.server
```

### Available Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `TREE_API_DB_PATH` | Path to SQLite database file | `data/trees.db` |
| `TREE_API_HOST` | Host/interface to bind | `127.0.0.1` |
| `TREE_API_PORT` | Port for the HTTP server | `8000` |

## API Documentation

### Endpoints

#### `GET /api/tree`

**Description**: Retrieve all trees (forest) as nested JSON.

**Response**: `200 OK`

**Response Body**:
```json
[
  {
    "id": 1,
    "label": "root",
    "children": [
      {
        "id": 2,
        "label": "child",
        "children": []
      }
    ]
  }
]
```

**Example**:
```bash
curl http://127.0.0.1:8000/api/tree
```

---

#### `POST /api/tree`

**Description**: Create a new node, optionally attaching it to a parent.

**Request Headers**:
- `Content-Type: application/json`

**Request Body**:
```json
{
  "label": "string (required)",
  "parent_id": "integer (optional)"
}
```

**Response**: `201 Created`

**Response Body**:
```json
{
  "id": 1,
  "label": "node label",
  "children": []
}
```

**Examples**:

Create a root node:
```bash
curl -X POST http://127.0.0.1:8000/api/tree \
  -H 'Content-Type: application/json' \
  -d '{"label": "root"}'
```

Create a child node:
```bash
curl -X POST http://127.0.0.1:8000/api/tree \
  -H 'Content-Type: application/json' \
  -d '{"label": "child", "parent_id": 1}'
```

### Error Responses

#### `400 Bad Request`
- Empty or whitespace-only label
- Invalid JSON body
- Invalid parent_id type

**Example**:
```json
{
  "error": "label is required",
  "status": 400
}
```

#### `404 Not Found`
- Parent node doesn't exist
- Unknown endpoint

**Example**:
```json
{
  "error": "Parent node 999 does not exist",
  "status": 404
}
```

#### `500 Internal Server Error`
- Unexpected server errors

### Complete Usage Example

```bash
# 1. Create root node
curl -X POST http://127.0.0.1:8000/api/tree \
  -H 'Content-Type: application/json' \
  -d '{"label": "Company"}'
# Response: {"id": 1, "label": "Company", "children": []}

# 2. Create department
curl -X POST http://127.0.0.1:8000/api/tree \
  -H 'Content-Type: application/json' \
  -d '{"label": "Engineering", "parent_id": 1}'
# Response: {"id": 2, "label": "Engineering", "children": []}

# 3. Create team
curl -X POST http://127.0.0.1:8000/api/tree \
  -H 'Content-Type: application/json' \
  -d '{"label": "Backend", "parent_id": 2}'
# Response: {"id": 3, "label": "Backend", "children": []}

# 4. View the complete tree
curl http://127.0.0.1:8000/api/tree | python -m json.tool
```

**Result**:
```json
[
  {
    "id": 1,
    "label": "Company",
    "children": [
      {
        "id": 2,
        "label": "Engineering",
        "children": [
          {
            "id": 3,
            "label": "Backend",
            "children": []
          }
        ]
      }
    ]
  }
]
```

## Testing

### Run All Tests

```bash
python -m unittest discover -s tests -v
```

### Run Specific Test File

```bash
# Test service layer
python -m unittest tests.test_tree_service

# Test HTTP server
python -m unittest tests.test_server
```

### Test Coverage

The test suite includes:

**Service Layer Tests** (`test_tree_service.py`):
- âœ… Creating root nodes
- âœ… Creating child nodes
- âœ… Validating required fields
- âœ… Handling missing parent references
- âœ… Building nested tree structures

**HTTP API Tests** (`test_server.py`):
- âœ… GET requests for empty forest
- âœ… POST requests to create nodes
- âœ… Nested children serialization
- âœ… HTTP status codes
- âœ… JSON request/response handling

**Test Isolation**: 
- Each test uses a temporary database
- No test data pollution between runs
- Server tests use dynamic port allocation
- Automatic cleanup after each test

## Design Decisions

### 1. Why Python Standard Library Only?

- **Simplicity**: No dependency management required
- **Portability**: Runs anywhere Python is installed
- **Learning**: Demonstrates core Python capabilities
- **Production-Ready**: Stdlib is battle-tested and stable

### 2. Why SQLite?

- **Zero Configuration**: No database server setup needed
- **File-Based**: Easy backups and migrations
- **ACID Compliant**: Reliable data integrity
- **Sufficient**: Perfect for small-to-medium data volumes
- **Standard Library**: Built into Python

### 3. Why ThreadingHTTPServer?

- **Concurrent Requests**: Handles multiple clients simultaneously
- **Simple**: No async complexity for this use case
- **Standard Library**: No need for external web frameworks
- **Adequate Performance**: Sufficient for typical API loads

### 4. Why Layered Architecture?

- **Separation of Concerns**: Each layer has a clear responsibility
- **Testability**: Layers can be tested independently
- **Maintainability**: Easy to modify one layer without affecting others
- **Scalability**: Easy to swap implementations (e.g., different database)

### 5. Why No Hardcoding?

- **Flexibility**: Configuration via environment variables
- **12-Factor App**: Follows modern deployment practices
- **Testing**: Easy to override paths for isolated tests
- **Production-Ready**: Different configs for dev/staging/prod

### 6. Data Model Design

**Schema**:
```sql
CREATE TABLE nodes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    label TEXT NOT NULL,
    parent_id INTEGER REFERENCES nodes(id)
)
```

- **Simple**: Only 3 columns needed
- **Self-Referencing**: parent_id creates the tree structure
- **Flexible**: NULL parent_id indicates root nodes
- **Scalable**: Supports any tree depth and multiple forests

### 7. Error Handling Strategy

- **HTTP Semantics**: Proper status codes (400, 404, 500)
- **Descriptive Messages**: Clear error messages for debugging
- **Custom Exceptions**: Domain-specific errors (ValidationError, NodeNotFound)
- **Defensive Programming**: Catches unexpected errors to prevent crashes

## Further Improvements

### Security Enhancements
- Authentication/authorization (JWT, API keys)
- Rate limiting to prevent abuse
- Input sanitization for XSS prevention
- HTTPS support with TLS certificates

### Performance Optimizations
- Database indexing on parent_id for faster queries
- Connection pooling for concurrent requests
- Caching for frequently accessed trees
- Pagination for large forests
- Lazy loading of deep tree structures

### Feature Additions
- **PATCH /api/tree/:id** - Update node labels
- **DELETE /api/tree/:id** - Delete nodes and subtrees
- **GET /api/tree/:id** - Retrieve a specific subtree
- **POST /api/tree/bulk** - Batch node creation
- Search/filter nodes by label
- Tree statistics (depth, node count, etc.)
- Export trees as different formats (XML, YAML)

### Production Readiness
- Async server (asyncio, aiohttp, FastAPI)
- Structured logging with rotation
- Health check endpoint
- Metrics and monitoring (Prometheus)
- Database migrations system
- Docker containerization
- Kubernetes deployment manifests
- CI/CD pipeline configuration

### Code Quality
- Code coverage reporting (target >90%)
- Performance benchmarking
- Load testing scenarios
- API documentation (OpenAPI/Swagger)
- Pre-commit hooks for linting

## License

This project is created as an assessment/demonstration project.

## Author

Created as a coding challenge to demonstrate:
- Clean architecture principles
- Python best practices
- RESTful API design
- Test-driven development
- Production-ready code structure

---

**Happy tree building! ðŸŒ²**
